(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2697],{82697:function(e,t,n){"use strict";n.d(t,{Z:function(){return x}});var s=n(57437),o=n(15238),a=n.n(o),l=n(2265),i=n(89178),r=n(94880),c=n(58485),u=n(16288),d=n(20721),g=n(26100),h=n(19666),v=n(50495),m=e=>{let{name:t,avatar:n,link:o,description:a}=e;return(0,s.jsx)("div",{className:"relative group flex",children:(0,s.jsx)(h.pn,{children:(0,s.jsxs)(h.u,{delayDuration:0,children:[(0,s.jsx)(h.aJ,{asChild:!0,children:(0,s.jsxs)(v.z,{variant:"ghost",className:"flex items-center justify-center",children:[n,(0,s.jsx)("div",{children:t})]})}),(0,s.jsx)(h._v,{children:(0,s.jsxs)("div",{className:"w-80 h-30",children:[(0,s.jsx)("a",{href:o,target:"_blank",rel:"noreferrer",className:"mt-1 ml-2 block no-underline",children:(0,s.jsxs)("div",{className:"flex items-center justify-start gap-2",children:[n,(0,s.jsxs)("div",{className:"mr-2 mt-1 flex justify-center items-center text-sm font-semibold text-gray-800",children:[t,(0,s.jsx)(g.o,{weight:"bold",className:"ml-1"})]})]})}),a&&(0,s.jsx)("p",{className:"mt-2 ml-6 text-sm text-gray-600 line-clamp-2",children:a||"A Khoj agent"})]})})]})})})},f=n(89417),p=n(69591);function x(e){var t,n,o,g,h,v,x,b,j;let[y,M]=(0,l.useState)(null),[_,w]=(0,l.useState)(0),[C,N]=(0,l.useState)(!0),I=(0,l.useRef)(null),S=(0,l.useRef)(null),k=(0,l.useRef)(null),H=(0,l.useRef)(null),[L,T]=(0,l.useState)(null),[E,A]=(0,l.useState)(!1),[O,R]=(0,l.useState)(!0),q=(0,p.IC)(),D="[data-radix-scroll-area-viewport]";(0,l.useEffect)(()=>{var e;let t=null===(e=S.current)||void 0===e?void 0:e.querySelector(D);if(!t)return;let n=()=>{let{scrollTop:e,scrollHeight:n,clientHeight:s}=t;R(n-(e+s)<=50)};return t.addEventListener("scroll",n),()=>t.removeEventListener("scroll",n)},[]),(0,l.useEffect)(()=>{e.incomingMessages&&e.incomingMessages.length>0&&O&&Z()},[e.incomingMessages,O]),(0,l.useEffect)(()=>{y&&y.chat&&y.chat.length>0&&_<2&&requestAnimationFrame(()=>{var e;null===(e=k.current)||void 0===e||e.scrollIntoView({behavior:"auto",block:"start"})})},[y,_]),(0,l.useEffect)(()=>{if(!C||E)return;let t=new IntersectionObserver(t=>{t[0].isIntersecting&&C&&(A(!0),function(t){if(!C||E)return;let n=(t+1)*10,s="";if(e.conversationId)s="/api/chat/history?client=web&conversation_id=".concat(encodeURIComponent(e.conversationId),"&n=").concat(n);else{if(!e.publicConversationSlug)return;s="/api/chat/share/history?client=web&public_conversation_slug=".concat(e.publicConversationSlug,"&n=").concat(n)}fetch(s).then(e=>e.json()).then(n=>{if(e.setTitle(n.response.slug),n&&n.response&&n.response.chat&&n.response.chat.length>0){if(w(Math.ceil(n.response.chat.length/10)),n.response.chat.length===(null==y?void 0:y.chat.length)){N(!1),A(!1);return}e.setAgent(n.response.agent),M(n.response),A(!1),0===t?Z(!0):W()}else{if(n.response.agent&&n.response.conversation_id){let t={chat:[],agent:n.response.agent,conversation_id:n.response.conversation_id,slug:n.response.slug};e.setAgent(n.response.agent),M(t)}N(!1),A(!1)}}).catch(e=>{console.error(e),window.location.href="/"})}(_))},{threshold:1});return I.current&&t.observe(I.current),()=>t.disconnect()},[C,_,E]),(0,l.useEffect)(()=>{N(!0),A(!1),w(0),M(null)},[e.conversationId]),(0,l.useEffect)(()=>{if(e.incomingMessages){let t=e.incomingMessages[e.incomingMessages.length-1];t&&!t.completed&&(T(e.incomingMessages.length-1),e.setTitle(t.rawQuery))}},[e.incomingMessages]);let W=()=>{var e;let t=null===(e=S.current)||void 0===e?void 0:e.querySelector(D);requestAnimationFrame(()=>{var e;null===(e=H.current)||void 0===e||e.scrollIntoView({behavior:"auto",block:"start"}),null==t||t.scrollBy({behavior:"smooth",top:-150})})},Z=function(){var e;let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=null===(e=S.current)||void 0===e?void 0:e.querySelector(D);requestAnimationFrame(()=>{null==n||n.scrollTo({top:n.scrollHeight,behavior:t?"auto":"smooth"})}),R(!0)};return e.conversationId||e.publicConversationSlug?(0,s.jsx)(r.x,{className:"h-[80vh] relative",ref:S,children:(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:a().chatHistory,children:[(0,s.jsx)("div",{ref:I,style:{height:"1px"},children:E&&(0,s.jsx)(c.l,{message:"Loading Conversation",className:"opacity-50"})}),y&&y.chat&&y.chat.map((e,t)=>{var n;return(0,s.jsx)(i.Z,{ref:t===y.chat.length-2?k:t===y.chat.length-(_-1)*10?H:null,isMobileWidth:q,chatMessage:e,customClassName:"fullHistory",borderLeftColor:"".concat(null==y?void 0:null===(n=y.agent)||void 0===n?void 0:n.color,"-500"),isLastMessage:t===y.chat.length-1},"".concat(t,"fullHistory"))}),e.incomingMessages&&e.incomingMessages.map((e,t)=>{var n,o,r;return(0,s.jsxs)(l.Fragment,{children:[(0,s.jsx)(i.Z,{isMobileWidth:q,chatMessage:{message:e.rawQuery,context:[],onlineContext:{},created:e.timestamp,by:"you",automationId:"",uploadedImageData:e.uploadedImageData},customClassName:"fullHistory",borderLeftColor:"".concat(null==y?void 0:null===(n=y.agent)||void 0===n?void 0:n.color,"-500")},"".concat(t,"outgoing")),e.trainOfThought&&function(e,t,n,o){let l=arguments.length>4&&void 0!==arguments[4]&&arguments[4],r=e.length-1;return(0,s.jsxs)("div",{className:"".concat(a().trainOfThought," shadow-sm"),children:[!l&&(0,s.jsx)(c.l,{className:"float-right"}),e.map((e,o)=>(0,s.jsx)(i.H,{message:e,primary:o===r&&t&&!l,agentColor:n},"train-".concat(o)))]},o)}(e.trainOfThought,t===L,(null==y?void 0:null===(o=y.agent)||void 0===o?void 0:o.color)||"orange","".concat(t,"trainOfThought"),e.completed),(0,s.jsx)(i.Z,{isMobileWidth:q,chatMessage:{message:e.rawResponse,context:e.context,onlineContext:e.onlineContext,created:e.timestamp,by:"khoj",automationId:"",rawQuery:e.rawQuery},customClassName:"fullHistory",borderLeftColor:"".concat(null==y?void 0:null===(r=y.agent)||void 0===r?void 0:r.color,"-500"),isLastMessage:!0},"".concat(t,"incoming"))]},"incomingMessage".concat(t))}),e.pendingMessage&&(0,s.jsx)(i.Z,{isMobileWidth:q,chatMessage:{message:e.pendingMessage,context:[],onlineContext:{},created:new Date().getTime().toString(),by:"you",automationId:"",uploadedImageData:e.pendingMessage},customClassName:"fullHistory",borderLeftColor:"".concat(null==y?void 0:null===(t=y.agent)||void 0===t?void 0:t.color,"-500"),isLastMessage:!0},"pendingMessage-".concat(e.pendingMessage.length)),y&&(0,s.jsx)("div",{className:"".concat(a().agentIndicator," pb-4"),children:(0,s.jsx)("div",{className:"relative group mx-2 cursor-pointer",children:(0,s.jsx)(m,{name:y&&y.agent&&(null===(g=y.agent)||void 0===g?void 0:g.name)?null===(h=y.agent)||void 0===h?void 0:h.name:"Agent",link:y&&y.agent&&(null===(v=y.agent)||void 0===v?void 0:v.slug)?"/agents?agent=".concat(null===(x=y.agent)||void 0===x?void 0:x.slug):"/agents",avatar:(0,f.TI)(null===(n=y.agent)||void 0===n?void 0:n.icon,null===(o=y.agent)||void 0===o?void 0:o.color)||(0,s.jsx)(u.v,{}),description:y&&y.agent&&(null===(b=y.agent)||void 0===b?void 0:b.persona)?null===(j=y.agent)||void 0===j?void 0:j.persona:"Your agent is no longer available. You will be reset to the default agent."})})})]}),!O&&(0,s.jsx)("button",{title:"Scroll to bottom",className:"absolute bottom-4 right-5 bg-white dark:bg-[hsl(var(--background))] text-neutral-500 dark:text-white p-2 rounded-full shadow-xl",onClick:()=>{Z(),R(!0)},children:(0,s.jsx)(d.K,{size:24})})]})}):null}},15238:function(e){e.exports={chatHistory:"chatHistory_chatHistory__CoaVT",chatLayout:"chatHistory_chatLayout__ABli_",agentIndicator:"chatHistory_agentIndicator__wOU1f",trainOfThought:"chatHistory_trainOfThought__mMWSR"}}}]);