"use strict";(self.webpackChunkjupyterlab_collaborative_chat_extension=self.webpackChunkjupyterlab_collaborative_chat_extension||[]).push([[119],{3119:(e,t,s)=>{s.r(t),s.d(t,{ChatPanel:()=>M,ChatWidgetFactory:()=>S,CollaborativeChatModel:()=>d,CollaborativeChatModelFactory:()=>I,CollaborativeChatPanel:()=>w,CommandIDs:()=>p,IActiveCellManagerToken:()=>y,IChatFactory:()=>_,IChatPanel:()=>C,ISelectionWatcherToken:()=>b,WidgetConfig:()=>k,YChat:()=>r,chatFileType:()=>m});var a=s(5652),i=s(2135),n=s(4602),o=s(7262),h=s(2697);class r extends h.YDocument{constructor(e){super(e),this.version="1.0.0",this._usersObserver=e=>{const t=new Array;e.keysChanged.forEach((s=>{const a=e.changes.keys.get(s);if(a)switch(a.action){case"add":t.push({key:s,newValue:this._users.get(s),type:"add"});break;case"delete":t.push({key:s,oldValue:a.oldValue,type:"remove"});break;case"update":t.push({key:s,oldValue:a.oldValue,newValue:this._users.get(s),type:"change"})}})),this._changed.emit({userChange:t})},this._messagesObserver=e=>{const t=e.delta;this._changed.emit({messageChanges:t})},this._metadataObserver=e=>{const t=new Array;e.changes.keys.forEach(((e,s)=>{switch(e.action){case"add":t.push({key:s,newValue:this._metadata.get(s),type:"add"});break;case"delete":t.push({key:s,oldValue:e.oldValue,type:"remove"});break;case"update":t.push({key:s,oldValue:e.oldValue,newValue:this._metadata.get(s),type:"change"})}})),this._changed.emit({metadataChanges:t})},this._users=this.ydoc.getMap("users"),this._users.observe(this._usersObserver),this._messages=this.ydoc.getArray("messages"),this._messages.observe(this._messagesObserver),this._metadata=this.ydoc.getMap("metadata"),this._metadata.observe(this._metadataObserver)}static create(e){return new r(e)}get id(){return this._metadata.get("id")||""}get users(){return o.JSONExt.deepCopy(this._users.toJSON())}get messages(){return o.JSONExt.deepCopy(this._messages.toJSON())}getUser(e){if(e)return this._users.get(e)}setUser(e){this.transact((()=>{this._users.set(e.username,e)}))}getMessage(e){return this._messages.get(e)}addMessage(e){this.transact((()=>{this._messages.push([e])}))}updateMessage(e,t){this.transact((()=>{this._messages.delete(e),this._messages.insert(e,[t])}))}getMessageIndex(e){return this._messages.toArray().findIndex((t=>t.id===e))}deleteMessage(e){this.transact((()=>{this._messages.delete(e)}))}}class d extends a.ChatModel{constructor(e){super(e),this.collaborative=!0,this.onAwarenessChange=()=>{const e=[],t=this.sharedModel.awareness.getStates();for(const s of t.keys()){const a=t.get(s);a&&a.user&&a.user.username!==this.user.username&&a.isWriting&&e.push(a.user)}this.updateWriters(e)},this._onchange=(e,t)=>{if(t.messageChanges){const e=t.messageChanges;let s=0;e.forEach((e=>{if(e.retain)s+=e.retain;else if(e.insert){const t=e.insert.map((e=>({...e,sender:this.sharedModel.getUser(e.sender)||{username:"User undefined"}})));this.messagesInserted(s,t),s+=t.length}else e.delete&&this.messagesDeleted(s,e.delete)}))}t.metadataChanges&&t.metadataChanges.forEach((e=>{"id"===e.key&&(this.id=e.newValue)}))},this.defaultKernelName="",this.defaultKernelLanguage="",this._dirty=!1,this._readOnly=!1,this._disposed=new n.Signal(this),this._contentChanged=new n.Signal(this),this._stateChanged=new n.Signal(this),this._timeoutWriting=null,this._user=e.user||{username:"user undefined"};const{widgetConfig:t,sharedModel:s}=e;this._sharedModel=s||r.create(),this.id=this._sharedModel.id,this.sharedModel.changed.connect(this._onchange,this),this.config=t.config,t.configChanged.connect(((e,t)=>{this.config=t})),this.sharedModel.awareness.on("change",this.onAwarenessChange)}get user(){return this._user}get sharedModel(){return this._sharedModel}get contentChanged(){return this._contentChanged}get stateChanged(){return this._stateChanged}get dirty(){return this._dirty}set dirty(e){this._dirty=e}get readOnly(){return this._readOnly}set readOnly(e){this._readOnly=e}get disposed(){return this._disposed}dispose(){this.isDisposed||(super.dispose(),this._sharedModel.dispose(),this._disposed.emit(),n.Signal.clearData(this))}toString(){return JSON.stringify({},null,2)}fromString(e){}toJSON(){return JSON.parse(this.toString())}fromJSON(e){}sendMessage(e){this._resetWritingStatus(),null!==this._timeoutWriting&&window.clearTimeout(this._timeoutWriting);const t={type:"msg",id:o.UUID.uuid4(),body:e.body,time:Date.now()/1e3,sender:this._user.username,raw_time:!0};this.sharedModel.getUser(this._user.username)!==this._user&&this.sharedModel.setUser(this._user),this.sharedModel.addMessage(t)}updateMessage(e,t){const s=this.sharedModel.getMessageIndex(e);let a=this.sharedModel.getMessage(s);if(a)a.body=t.body,a.edited=!0;else{const s=t.sender.username;a={type:"msg",id:e||o.UUID.uuid4(),body:t.body,time:t.time||Date.now()/1e3,sender:s,edited:!0}}this.sharedModel.updateMessage(s,a)}deleteMessage(e){const t=this.sharedModel.getMessageIndex(e),s=this.sharedModel.getMessage(t);s?(s.body="",s.deleted=!0,this.sharedModel.updateMessage(t,s)):console.error("The message to delete does not exist")}inputChanged(e){if(!e||!this.config.sendTypingNotification)return;const t=this.sharedModel.awareness;null!==this._timeoutWriting&&window.clearTimeout(this._timeoutWriting),t.setLocalStateField("isWriting",!0),this._timeoutWriting=window.setTimeout((()=>{this._resetWritingStatus()}),1e3)}_resetWritingStatus(){const e=this.sharedModel.awareness,t=e.getLocalState();null==t||delete t.isWriting,e.setLocalState(t),this._timeoutWriting=null}}var l=s(1473),c=s(7460),g=s(3345),u=s.n(g);const m={name:"chat",displayName:"Chat",mimeTypes:["text/json","application/json"],extensions:[".chat"],fileFormat:"text",contentType:"chat",icon:a.chatIcon},_=new o.Token("jupyter-collaborative-chat:IChatFactory"),p={createChat:"collaborative-chat:create",openChat:"collaborative-chat:open",moveToSide:"collaborative-chat:moveToSide",markAsRead:"collaborative-chat:markAsRead",focusInput:"collaborative-chat:focusInput"},C=new o.Token("jupyter-collaborative-chat:IChatPanel"),y=new o.Token("jupyter-collaborative-chat:IActiveCellManager"),b=new o.Token("jupyter-collaborative-chat:ISelectionWatcher"),f="jp-collab-chat-title-unread";class w extends i.DocumentWidget{constructor(e){super(e),this._unreadChanged=(e,t)=>{t.length?this.title.className.includes(f)||(this.title.className+=` ${f}`):this.title.className=this.title.className.replace(f,"")},this.addClass("jp-collab-chat-main-panel"),this.model.name=this.context.localPath,this.model.unreadChanged.connect(this._unreadChanged)}dispose(){this.model.unreadChanged.disconnect(this._unreadChanged),this.context.dispose(),this.content.dispose(),super.dispose()}get model(){return this.context.model}}class M extends c.SidePanel{constructor(e){super(e),this.updateChatNames=async()=>{const e=m.extensions[0];this._drive.get(".").then((t=>{const s={};t.content.filter((t=>"file"===t.type&&t.name.endsWith(e))).forEach((t=>s[l.PathExt.basename(t.name,e)]=t.name)),this._chatNamesChanged.emit(s)})).catch((e=>console.error("Error getting the chat files from drive",e)))},this._chatSelected=e=>{const t=e.target,s=t.value;"-"!==t.options[t.selectedIndex].textContent&&(this._commands.execute(p.openChat,{filepath:s,inSidePanel:!0}),e.target.selectedIndex=0)},this._chatNamesChanged=new n.Signal(this),this._config={},this.addClass("jp-collab-chat-sidepanel"),this._commands=e.commands,this._drive=e.drive,this._rmRegistry=e.rmRegistry,this._themeManager=e.themeManager,this._autocompletionRegistry=e.autocompletionRegistry;const t=new c.CommandToolbarButton({commands:this._commands,id:p.createChat,args:{inSidePanel:!0},icon:c.addIcon});t.addClass("jp-collab-chat-add"),this.toolbar.addItem("createChat",t),this._openChat=c.ReactWidget.create(u().createElement(x,{chatNamesChanged:this._chatNamesChanged,handleChange:this._chatSelected.bind(this)})),this._openChat.addClass("jp-collab-chat-open"),this.toolbar.addItem("openChat",this._openChat),this.content.expansionToggled.connect(this._onExpansionToggled,this)}get config(){return this._config}set config(e){this._config={...this._config,...e},this.widgets.forEach((t=>{t.model.config=e}))}addChat(e,t,s){const i=this.content;for(let e=0;e<this.widgets.length;e++)i.collapse(e);e.name=t;const n=new a.ChatWidget({model:e,rmRegistry:this._rmRegistry,themeManager:this._themeManager,autocompletionRegistry:this._autocompletionRegistry});this.addWidget(new v({name:t,widget:n,commands:this._commands,path:s}))}openIfExists(e){const t=this._getChatIndex(e);return t>-1&&this._expandChat(t),t>-1}onAfterShow(e){var t;null===(t=this._openChat.renderPromise)||void 0===t||t.then((()=>this.updateChatNames()))}_getChatIndex(e){return this.widgets.findIndex((t=>t.path===e))}_expandChat(e){this.widgets[e].isVisible||this.content.expand(e)}_onExpansionToggled(e,t){if(this.widgets[t].isVisible)for(let s=0;s<this.widgets.length;s++)s!==t&&e.collapse(s)}}class v extends c.PanelWithToolbar{constructor(e){var t;super(e),this._unreadChanged=(e,t)=>{this._markAsRead.enabled=t.length>0},this.addClass("jp-collab-chat-section"),this._name=e.name,this._path=e.path,this.title.label=this._name,this.title.caption=this._path,this.toolbar.addClass("jp-collab-chat-toolbar"),this._markAsRead=new c.ToolbarButton({icon:a.readIcon,iconLabel:"Mark chat as read",className:"jp-mod-styled",onClick:()=>this.model.unreadMessages=[]});const s=new c.ToolbarButton({icon:c.launchIcon,iconLabel:"Move the chat to the main area",className:"jp-mod-styled",onClick:()=>{this.model.dispose(),e.commands.execute(p.openChat,{filepath:`${this._name}${m.extensions[0]}`}),this.dispose()}}),i=new c.ToolbarButton({icon:c.closeIcon,iconLabel:"Close the chat",className:"jp-mod-styled",onClick:()=>{this.model.dispose(),this.dispose()}});this.toolbar.addItem("collaborativeChat-markRead",this._markAsRead),this.toolbar.addItem("collaborativeChat-moveMain",s),this.toolbar.addItem("collaborativeChat-close",i),this.addWidget(e.widget),null===(t=this.model.unreadChanged)||void 0===t||t.connect(this._unreadChanged),this._markAsRead.enabled=this.model.unreadMessages.length>0,e.widget.node.style.height="100%"}get path(){return this._path}get name(){return this._name}get model(){return this.widgets[0].model}dispose(){var e;null===(e=this.model.unreadChanged)||void 0===e||e.disconnect(this._unreadChanged),super.dispose()}}function x({chatNamesChanged:e,handleChange:t}){const[s,a]=(0,g.useState)({});return e.connect(((e,t)=>{a(t)})),u().createElement(c.HTMLSelect,{onChange:t},u().createElement("option",{value:"-"},"Open a chat"),Object.keys(s).map((e=>u().createElement("option",{value:s[e]},e))))}class k{constructor(e){this._configChanged=new n.Signal(this),this._config=e}get config(){return this._config}set config(e){this._config={...this._config,...e},this._configChanged.emit(e)}get configChanged(){return this._configChanged}}class S extends i.ABCWidgetFactory{constructor(e){super(e),this._themeManager=e.themeManager,this._rmRegistry=e.rmRegistry,this._autocompletionRegistry=e.autocompletionRegistry}createNewWidget(e){return e.rmRegistry=this._rmRegistry,e.themeManager=this._themeManager,e.autocompletionRegistry=this._autocompletionRegistry,new w({context:e,content:new a.ChatWidget(e)})}}class I{constructor(e){var t,s;this.collaborative=!0,this._disposed=!1,this._user=e.user,this._widgetConfig=e.widgetConfig,this._commands=e.commands,this._activeCellManager=null!==(t=e.activeCellManager)&&void 0!==t?t:null,this._selectionWatcher=null!==(s=e.selectionWatcher)&&void 0!==s?s:null}get name(){return"chat"}get contentType(){return"chat"}get fileFormat(){return"text"}get isDisposed(){return this._disposed}dispose(){this._disposed=!0}preferredLanguage(e){return""}createNew(e){return new d({...e,user:this._user,widgetConfig:this._widgetConfig,commands:this._commands,activeCellManager:this._activeCellManager,selectionWatcher:this._selectionWatcher})}}}}]);