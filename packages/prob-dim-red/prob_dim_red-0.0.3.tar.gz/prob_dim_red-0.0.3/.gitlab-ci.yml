image: "python:3.10"

stages:
  - linting
  - tests
  - build
  - publish

black:
  stage: linting
  image: registry.gitlab.com/pipeline-components/black:latest
  script:
    - black --check --verbose -- .
  tags:
    - docker

pylint:
  stage: linting
  before_script:
    - pip install pylint
  script:
    - find . -type f -name "*.py" |
      xargs pylint
          --disable=import-error
          --load-plugins=pylint.extensions.docparams

run_tests_py310:
  stage: tests
  image: "python:3.10"
  before_script:
    - pip install pytest
  script:
    - pip install .
    - pytest -m minimal

run_tests_py311:
  stage: tests
  image: "python:3.11"
  before_script:
    - pip install pytest
  script:
    - pip install .
    - pytest -m minimal

run_tests_py312:
  stage: tests
  image: "python:3.12"
  before_script:
    - pip install pytest
  script:
    - pip install .
    - pytest -m minimal

build_package:
  stage: build
  before_script:
    - pip install build
  script:
    - rm -rf dist/
    - python -m build
  artifacts:
    untracked: true
    expire_in: 1 week
  tags:
    - docker

publish_package:
  stage: publish
  before_script:
    - pip install twine
  script:
    - TWINE_PASSWORD=${CI_JOB_TOKEN}
      TWINE_USERNAME=gitlab-ci-token
      python -m twine upload
        --repository-url ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi dist/*
  tags:
    - docker
  only:
    - tags

build_doc:
  stage: build
  script:
    - pip install .[doc]
    - make -C doc html
  artifacts:
    untracked: true
    expire_in: 1 week
  tags:
    - docker

pages:
  stage: publish
  script:
    - rm -rf public/
    - cp -r doc/build/html public/
  artifacts:
    paths:
    - public
  tags:
    - docker
  only:
    - tags
