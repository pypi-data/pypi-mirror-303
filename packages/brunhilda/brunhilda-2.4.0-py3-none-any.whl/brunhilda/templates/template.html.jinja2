<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <title>Test Run Report {% if env_info.name %}[{{ env_info.name }}]{% endif %}</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
            {% include "themes/base.css" %}
        </style>
        <script src="https://code.jquery.com/jquery-3.4.1.slim.js"></script>
        <script>
            const results = ['passed', 'failed', 'errored', 'skipped', 'expected-failure', 'unexpected-success'];

            $(document).ready(function() {
                for (const result of results) {
                    (function(r) {
                        $("#run-summary--" + r).change(function() {
                            if (this.checked) {
                                $(".test--" + r).removeClass("test--hidden")
                            }
                            else {
                                $(".test--" + r).addClass("test--hidden")
                            }
                        });
                    })(result);
                }

                $(window).keypress(function( event ) {
                    var selector = null;

                    /* E */
                    if (event.which == 69 || event.which == 101) {
                        selector = ".test--errored";
                    }
                    /* P */
                    else if (event.which == 80 || event.which == 112) {
                        selector = ".test--passed";
                    }
                    /* F */
                    else if (event.which == 70 || event.which == 102) {
                        selector = ".test--failed";
                    }
                    /* S */
                    else if (event.which == 83 || event.which == 115) {
                        selector = ".test--skipped";
                    }
                    /* X */
                    else if (event.which == 88 || event.which == 120) {
                        selector = ".test--expected-failure";
                    }
                    /* U */
                    else if (event.which == 85 || event.which == 117) {
                        selector = ".test--unexpected-success";
                    }

                    if (selector != null) {
                        var current = $(".test--current");
                        var targets = $(selector);
                        var target = null;

                        if (targets.length == 0) {
                            return;
                        }
                        else if (current.length == 0) {
                            target = $(targets).first();
                        }
                        else {
                            const n = $(current).prevAll(selector).length;
                            var next = false;

                            /* Up - reverse order */
                            if (event.shiftKey) {
                                targets = $(targets.get().reverse())
                            }

                            for (var t of targets) {
                                var nth = $(t).prevAll(selector).length;
                                if (((nth > n) && !event.shiftKey) ||
                                    ((nth < n) && event.shiftKey)) {
                                    target = $(t)
                                    break;
                                }
                            }

                            if (target == null || target.length == 0) {
                                target = $(targets).first();
                            }
                        }

                        if (target.length != 0) {
                            var y = target.offset().top;
                            $(current).removeClass("test--current");
                            $(target).addClass("test--current").find("input").prop("checked", true);
                            $(document).scrollTop(y);
                        }
                    }
                });
            });
        </script>
    </head>
    <body>
        <h1>Test Run Report {% if env_info.name %}<strong>[{{ env_info.name }}]</strong>{% endif %}</h1>
        <div class="header">
            {% include "header.html.jinja2" %}
        </div>
        <div class="main">
{% if preamble %}
            <section class="preamble">
                {{ preamble }}
            </section>
{% endif %}
            <section>
                {% include "summary.html.jinja2" %}
                <div>
                    <h3>Help</h3>
                    <p>
                        Use following keys to quick jump:
                        <span class="keyboard__key">E</span> &ndash; next error,
                        <span class="keyboard__key">P</span> &ndash; next passed,
                        <span class="keyboard__key">F</span> &ndash; next failure,
                        <span class="keyboard__key">S</span> &ndash; next skipped,
                        <span class="keyboard__key">X</span> &ndash; next expected failure,
                        <span class="keyboard__key">U</span> &ndash; next unexpected success,
                        <span class="keyboard__key">Shift + &hellip;</span> &ndash; previous.
                    </p>
                </div>

                <div class="testsuites">
                    <h2>Results</h2>
                    {% set count = namespace(value=0) %}

                    <div class="testsuite_results">
                        {% for testcase in result.testcases.values() %}
                        <div class="testcase testcase--{{ testcase.result|lower|replace(' ', '-') }}">
                            <label class="testcase__header" for="testcase_expand_{{ testcase.name }}">
                                <h3 class="testcase__name">{{ testcase.name }}</h3>
                                <p class="testcase__summary">
                                    <span class="testcase__summary--time">
                                        Executed in {{ '%0.3f'|format(testcase.time|float) }}s</span>,
                                    <span class="testcase__summary--passed">
                                        passed: <strong>{{ testcase.passed }}</strong></span>,
                                    <span class="testcase__summary--errored">
                                        errored: <strong>{{ testcase.errored }}</strong></span>,
                                    <span class="testcase__summary--failed">
                                        failed: <strong>{{ testcase.failed }}</strong></span>,
                                    <span class="testcase__summary--skipped">
                                        skipped: <strong>{{ testcase.skipped }}</strong></span>,
                                    <span class="testcase__summary--expected-failure">
                                        expected failures: <strong>{{ testcase.expected_failures }}</strong></span>,
                                    <span class="testcase__summary--unexpected-success">
                                        unexpected success: <strong>{{ testcase.unexpected_successes }}</strong></span>.
                                </p>
                            </label>
                            <input type="checkbox" id="testcase_expand_{{ testcase.name }}" class="testcase__expander" checked>
                            <div class="testcase__description">
                                <div class="testcase__description__content">{{ testcase.description }}</div>
                            </div>

                            {% for test in testcase.tests %}
                            {% set count.value = count.value + 1 %}
                            <div class="test test--{{ test.result|lower|replace(' ', '-') }}" id="{{ testcase.name }}.{{ test.name }}" result-nth="{{count.value}}">
                                <label class="test__header" for="test_expand_{{count.value}}">
                                    <span class="test__result">{{ test.result|lower }}</span>
                                    <span class="test__name">
                                        <strong>{{ test.name }}</strong>
                                        {% if test.subtests %}({{ test.subtests|length }} sub-tests){% endif %}
                                    </span>
                                    <span class="test__time">{{ '%0.3f'|format(test.time|float) }}s</span>
                                </label>
                                <input type="checkbox" id="test_expand_{{count.value}}" class="test__expander">
                                <div class="test__detail">
                                    <div class="test__detail__content">
                                        {% if test.skip_reason %}
                                        <div class="test__skipreason">
                                        <p>
                                            <strong>Skipped:</strong> <q>{{ test.skip_reason }}</q>
                                        </p>
                                        </div>
                                        {% endif %}

                                        <div class="test__description">
                                            {{ test.description }}
                                        </div>

                                        <div class="test__steps">
                                            <table>
                                                <caption>Test Steps</caption>
                                                <thead>
                                                    <tr>
                                                        <th class="test__steps__number">Step</th>
                                                        <th class="test__steps__description">Description</th>
                                                        <th class="test__steps__expectation">Expectation</th>
                                                        <th class="test__steps__obtained">Obtained</th>
                                                        <th class="test__steps__result">Result</th>
                                                        <th class="test__steps__comments">Comments</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                {% for step in test.steps %}
                                                            <tr>
                                                                <td class="test__steps__number">{{ step.number }}</td>
                                                                <td class="test__steps__description">{{ step.description }}</td>
                                                                <td class="test__steps__expectation">{{ step.expectation }}</td>
                                                                <td class="test__steps__obtained">{{ step.obtained }}</td>
                                                                <td class="test__steps__result test__steps__result--{{ step.result|lower|replace(' ', '-') }}">
                                                                    {{ step.result }}
                                                                </td>
                                                                <td class="test__steps__comments">
                                                                    {{ step.comment }}
                                                                </td>
                                                            </tr>
                                                {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>

                                        {% if test.subtests %}
                                        <table class="subtests">
                                            <caption>Sub-tests</caption>
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Sub-test</th>
                                                    <th>Result</th>
                                                    <th>Detail</th>
                                                    <th>Extra</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for subtest in test.subtests %}
                                                <tr class="subtest subtest--{{ subtest.result|lower|replace(' ', '-') }}"
                                                    id="{{ subtest.id|replace(' ', '_') }}">
                                                    <td class="subtest__num">{{ subtest.num }}</td>
                                                    <td class="subtest__name">{{ subtest.name }}</td>
                                                    <td class="subtest__result">{{ subtest.result }}</td>
                                                    <td class="subtest__detail">
                                                    {% if subtest.error %}
                                                    <pre>{{ subtest.error }}</pre>
                                                    {% elif subtest.reason %}
                                                        {{ subtest.reason }}
                                                    {% endif %}
                                                    </td>
                                                    <td class="subtest__extra">
                                                        {% if subtest.extra %}
                                                        {% for extra in subtest.extra %}
                                                            {% if extra.type.startswith('image/') %}
                                                            <p><img class="subtest__extra__image" src="data:{{extra.type}};base64,{{extra.value}}" /></p>
                                                            {% elif extra.type == 'image-reference' %}
                                                            <p><img class="subtest__extra__image" src="{{ rel_path(document_path, quote(extra.value)) }}" /></p>
                                                            {% else %}
                                                            <pre class="subtest__extra__text">{{ extra.value }}</pre>
                                                            {% endif %}
                                                        {% endfor %}
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                        {% endif %}

                                        {% if test.output %}
                                        <h3>Output</h3>
                                        <div class="test__console">
                                            <pre>{{ test.output }}</pre>
                                        </div>
                                        {% endif %}

                                        {% if test.errors %}
                                        <h3>Errors</h3>
                                        {% for error in test.errors %}
                                        <div class="test__console test__console--error">
                                            <pre>{{ error|e }}</pre>
                                        </div>
                                        {% endfor %}
                                        {% endif %}

                                        {% if test.extra %}
                                        <h3>Extra</h3>
                                        {% for extra in test.extra %}
                                        <div class="test__extra">
                                            {% if extra.type.startswith('image/') %}
                                            <img class="test__extra__image" src="data:{{extra.type}};base64,{{extra.value}}" />
                                            {% elif extra.type == 'image-reference' %}
                                            <img class="test__extra__image" src="{{ rel_path(document_path, quote(extra.value)) }}" />
                                            {% else %}
                                            <pre class="test__extra__text">{{ extra.value }}</pre>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </section>
    </body>
</html>